# 요구사항 분석

**버전**: 1.0.0
**최종 수정**: 2025-10-28
**상태**: Active

---

## 문서 네비게이션

**다음**: [유스케이스 →](user-stories.md)

---

## 목차

1. [시스템 개요](#시스템-개요)
2. [기능 요구사항](#기능-요구사항)
3. [제약사항](#제약사항)
4. [요구사항 추적 매트릭스](#요구사항-추적-매트릭스)

---

## 시스템 개요

### 프로젝트 정보

**프로젝트명**: E-Commerce Backend Service
**목적**: 이커머스 플랫폼의 핵심 기능을 제공하는 백엔드 API 서비스
**버전**: 0.1.0
**아키텍처**: TBD (To Be Decided)

### 이해관계자

| 역할 | 책임사항 | 관심사항 |
|------|---------|---------|
| **개발자** | E-Commerce 서비스 구현 및 유지보수 | 확장 가능한 아키텍처, 코드 품질, 테스트 가능성 |

### 시스템 컨텍스트

> **참고**: 시스템 컨텍스트 다이어그램은 추후 아키텍처 결정 후 작성됩니다.

### 시스템 경계

**범위 내 (In Scope)**:

*사용자 기능*:
- 상품 조회 (카테고리, 옵션 포함)
- 장바구니 관리
- 주문 생성 및 결제 처리
- 쿠폰 발급 받기 및 사용
- 인기 상품 통계 조회
- 외부 데이터 플랫폼 연동
- 사용자 인증/인가 (이미 구현되어 있다고 가정)

*Admin 기능*:
- 상품 관리 (등록/수정/삭제)
- 상품 카테고리 관리
- 상품 옵션 관리
- 재고 관리
- 쿠폰 발급 관리 (쿠폰 생성/발급 설정)
- 주문 관리 (전체 주문 조회/상태 관리)
- Admin 인증/인가

> **참고**: Admin 기능은 현재 동일 서비스 내에 구현되지만, 비즈니스 도메인이 다르므로 향후 마이크로서비스로 분리 가능성을 고려하여 설계합니다.

**범위 외 (Out of Scope)**:
- 배송 관리
- 정산 시스템
- 고급 통계/분석 기능
- 외부 데이터 전송 모니터링 대시보드

---

## 기능 요구사항

### FR-PROD: 상품 조회

| ID | 요구사항 | 우선순위 | 상태 |
|----|---------|---------|------|
| **FR-PROD-01** | 사용자는 상품 목록을 조회할 수 있어야 함 | MUST | ⏳ 대기 |
| **FR-PROD-02** | 사용자는 상품 상세 정보를 조회할 수 있어야 함 | MUST | ⏳ 대기 |
| **FR-PROD-04** | 사용자는 상품 옵션 정보를 조회할 수 있어야 함 | MUST | ⏳ 대기 |
| **FR-PROD-05** | 사용자는 상품 목록을 가격순/인기순/최신순으로 정렬할 수 있어야 함 | SHOULD | ⏳ 대기 |
| **FR-PROD-06** | 사용자는 최근 3일간 인기 상품 Top 5를 조회할 수 있어야 함 | SHOULD | ⏳ 대기 |

#### 상세 설명

**FR-PROD-01: 상품 목록 조회**
- **입력**:
  - 페이지네이션 파라미터 (page, limit)
  - 정렬 기준 (선택)
- **처리 과정**:
  1. 요청 파라미터 유효성 검증
  2. 전체 상품 조회
  3. 정렬 기준 적용
  4. 페이지네이션 처리
- **출력**: 상품 목록 (ID, 이름, 가격, 재고 유무)
- **관련 유스케이스**: [UC-PROD-01](user-stories.md#uc-prod-01-상품-목록-조회)

**FR-PROD-02: 상품 상세 조회**
- **입력**: 상품 ID
- **처리 과정**:
  1. 상품 ID로 상품 조회
  2. 상품 옵션 정보 조회
  3. 재고 정보 조회 (재고 유무만 확인)
- **출력**: 상품 상세 정보 (이름, 가격, 설명, 옵션 목록, 재고 상태)
- **관련 유스케이스**: [UC-PROD-02](user-stories.md#uc-prod-02-상품-상세-조회)

**FR-PROD-04: 상품 옵션 조회**
- **입력**: 상품 ID
- **처리 과정**:
  1. 상품에 연결된 옵션 그룹 조회
  2. 각 옵션의 재고 상태 조회
  3. 옵션별 추가 가격 조회
- **출력**: 옵션 목록 (옵션명, 옵션값, 추가 가격, 재고 상태)
- **예시**:
  - 색상: 빨강(+0원, 재고있음), 파랑(+0원, 재고있음)
  - 사이즈: S(+0원, 품절), M(+0원, 재고있음)
- **관련 유스케이스**: [UC-PROD-02](user-stories.md#uc-prod-02-상품-상세-조회)

**FR-PROD-05: 상품 정렬**
- **정렬 기준**:
  - 가격순 (오름차순/내림차순)
  - 인기순 (판매량 기준)
  - 최신순 (등록일 기준)
- **기본값**: 최신순
- **관련 유스케이스**: [UC-PROD-01](user-stories.md#uc-prod-01-상품-목록-조회)

**FR-PROD-06: 인기 상품 통계**
- **입력**: 없음 (최근 3일 고정)
- **처리 과정**:
  1. 백그라운드 배치 작업으로 통계 계산 및 캐시 갱신
  2. 최근 3일간 완료된 주문 조회
  3. 상품별 판매 수량 집계
  4. 상품별 매출액 집계
  5. 상위 5개 추출 및 캐시 저장
- **출력**: 순위, 상품 정보, 판매 수량, 매출액
- **갱신 전략**:
  - 실시간 통계가 아닌 배치 계산 방식
  - 캐시 TTL: 15분
  - 백그라운드 배치 작업 주기: 10분마다 자동 갱신
  - API 응답은 캐시된 데이터 반환
- **관련 유스케이스**: [UC-PROD-03](user-stories.md#uc-prod-03-인기-상품-조회)

#### 비기능 요구사항

**NFR-PROD-PERF: 성능**
- 상품 목록 조회: 평균 200ms 이내 응답
- 상품 상세 조회: 평균 200ms 이내 응답
- 인기 상품 통계: 캐싱 활용 시 100ms 이내 응답

**NFR-PROD-RELI: 안정성**
- 상품 정보 조회 실패 시 적절한 에러 메시지 반환
- 존재하지 않는 상품 조회 시 404 에러
- 데이터베이스 장애 시 적절한 fallback 처리

---

### FR-CART: 장바구니

| ID | 요구사항 | 우선순위 | 상태 |
|----|---------|---------|------|
| **FR-CART-01** | 사용자는 장바구니에 상품을 추가할 수 있어야 함 | MUST | ⏳ 대기 |
| **FR-CART-02** | 사용자는 장바구니 상품의 수량을 변경할 수 있어야 함 | MUST | ⏳ 대기 |
| **FR-CART-03** | 사용자는 장바구니에서 상품을 제거할 수 있어야 함 | MUST | ⏳ 대기 |
| **FR-CART-04** | 사용자는 장바구니 목록을 조회할 수 있어야 함 | MUST | ⏳ 대기 |
| **FR-CART-05** | 시스템은 장바구니 총 금액을 계산하여 제공해야 함 | MUST | ⏳ 대기 |
| **FR-CART-06** | 사용자는 장바구니의 모든 상품을 한 번에 제거할 수 있어야 함 | SHOULD | ⏳ 대기 |

#### 상세 설명

**FR-CART-01: 장바구니 상품 추가**
- **입력**:
  - 상품 ID
  - 옵션 ID (선택)
  - 수량
- **처리 과정**:
  1. 상품 존재 여부 확인
  2. 옵션 유효성 확인
  3. 재고 수량 확인 ([공통 재고 확인 정책](#재고-확인-정책) 참조)
  4. 재고 부족 시 에러 반환
  5. 장바구니에 추가 또는 기존 수량 증가
- **출력**: 장바구니 항목 정보
- **실패 시**: 재고 부족 에러 메시지
- **관련 유스케이스**: [UC-CART-01](user-stories.md#uc-cart-01-장바구니-추가)

**FR-CART-02: 수량 변경**
- **입력**:
  - 장바구니 항목 ID
  - 변경할 수량
- **처리 과정**:
  1. 장바구니 항목 확인
  2. 재고 수량 확인 ([공통 재고 확인 정책](#재고-확인-정책) 참조)
  3. 재고 부족 시 에러 반환
  4. 수량 업데이트
- **출력**: 업데이트된 장바구니 항목
- **실패 시**: 재고 부족 에러 메시지
- **관련 유스케이스**: [UC-CART-02](user-stories.md#uc-cart-02-수량-변경)

**FR-CART-03: 상품 제거**
- **입력**: 장바구니 항목 ID
- **처리 과정**: 장바구니에서 항목 삭제
- **출력**: 삭제 확인 메시지
- **관련 유스케이스**: [UC-CART-03](user-stories.md#uc-cart-03-상품-제거)

**FR-CART-04: 장바구니 조회**
- **입력**: 없음 (사용자별 조회)
- **처리 과정**:
  1. 사용자의 장바구니 항목 조회
  2. 각 항목의 최신 상품 정보 조회
  3. 재고 상태 확인
- **출력**: 장바구니 항목 목록 (상품 정보, 옵션, 수량, 단가, 소계, 재고 상태)
- **관련 유스케이스**: [UC-CART-04](user-stories.md#uc-cart-04-장바구니-조회)

**FR-CART-05: 총 금액 계산**
- **계산 방식**:
  ```
  각 항목별 소계 = (상품 가격 + 옵션 추가 가격) × 수량
  장바구니 총액 = Σ(항목별 소계)
  ```
- **출력**: 총 금액
- **관련 유스케이스**: [UC-CART-04](user-stories.md#uc-cart-04-장바구니-조회)

**FR-CART-06: 장바구니 전체 비우기**
- **입력**: 없음 (사용자별 처리)
- **처리 과정**:
  1. 사용자의 모든 장바구니 항목 조회
  2. 모든 항목 일괄 삭제
- **출력**: 삭제된 항목 수
- **비고**:
  - 빈 장바구니여도 에러 없이 성공 반환
  - 다른 사용자의 장바구니에는 영향 없음
- **관련 유스케이스**: [US-CART-06](user-stories.md#us-cart-06-장바구니-전체-비우기)

#### 비기능 요구사항

**NFR-CART-PERF: 성능**
- 장바구니 조회: 평균 200ms 이내 응답
- 장바구니 추가/수정/삭제: 평균 300ms 이내 응답

**NFR-CART-RELI: 안정성**
- 장바구니 항목은 영구 저장 (세션 만료 후에도 유지)
- 재고 부족 시 장바구니 추가 불가 (정확한 재고 기준 검증)
- 가격 계산의 정확성 보장

---

### FR-ORDER: 주문 관리

| ID | 요구사항 | 우선순위 | 상태 |
|----|---------|---------|------|
| **FR-ORDER-01** | 사용자는 장바구니 기반으로 주문을 생성할 수 있어야 함 | MUST | ⏳ 대기 |
| **FR-ORDER-02** | 시스템은 주문 생성 시 재고를 확인하고 확보해야 함 | MUST | ⏳ 대기 |
| **FR-ORDER-03** | 시스템은 쿠폰을 적용하여 주문 금액을 계산해야 함 | MUST | ⏳ 대기 |
| **FR-ORDER-04** | 시스템은 주문 상태를 관리해야 함 | MUST | ⏳ 대기 |
| **FR-ORDER-05** | 사용자는 주문 내역을 조회할 수 있어야 함 | MUST | ⏳ 대기 |

#### 상세 설명

**FR-ORDER-01: 주문 생성**
- **입력**:
  - 쿠폰 ID (선택)
- **처리 과정**:
  1. 사용자의 장바구니 전체 항목 조회
  2. 장바구니가 비어있는 경우 에러 반환
  3. 재고 확인 및 확보 (FR-ORDER-02 참조)
  4. 쿠폰 유효성 검증
  5. 주문 금액 계산
  6. 주문 생성 (PENDING 상태)
- **출력**: 주문 ID, 주문 상세 정보
- **비고**: 장바구니의 모든 항목으로 주문이 생성됨 (부분 주문 불가)
- **관련 유스케이스**: [UC-ORDER-01](user-stories.md#uc-order-01-주문-생성)

**FR-ORDER-02: 재고 확인 및 확보**
- **처리 과정**:
  1. 각 상품/옵션에 대해 비관적 락 획득 (SELECT FOR UPDATE)
  2. 재고 충분 여부 확인 ([공통 재고 확인 정책](#재고-확인-정책) 참조)
  3. 재고 부족 시 에러 반환
  4. 재고 확보 상태로 표시 (예약)
  5. 확보 시간 기록 (10분 타이머 시작)
- **확보 상태**:
  - 다른 사용자에게 해당 재고는 품절로 표시
  - 확보한 사용자만 결제 가능
- **유지 시간**: 10분 (600초)
- **타임아웃**: 10분 경과 시 자동 복원
- **실패 시**: 재고 부족 에러 메시지 ("상품명 - 옵션명이 품절입니다")
- **관련 유스케이스**: [UC-ORDER-01](user-stories.md#uc-order-01-주문-생성)

**FR-ORDER-03: 주문 금액 계산**
- **계산 과정**:
  1. 상품 금액 합계 계산
  2. 쿠폰 할인 금액 계산
  3. 최종 결제 금액 계산
- **계산식**:
  ```
  총 상품 금액 = Σ((상품 가격 + 옵션 추가 가격) × 수량)
  할인 금액 = 총 상품 금액 × (할인율 / 100)
  최종 결제 금액 = 총 상품 금액 - 할인 금액
  ```
- **관련 유스케이스**: [UC-ORDER-01](user-stories.md#uc-order-01-주문-생성)

**FR-ORDER-04: 주문 상태 관리**
- **상태 목록**:
  - PENDING: 결제 대기 (재고 확보됨)
  - COMPLETED: 결제 완료
  - FAILED: 결제 실패
  - CANCELLED: 주문 취소
  - EXPIRED: 재고 확보 만료 (10분 경과)
- **상태 전이 규칙**:
  - PENDING → COMPLETED: 결제 성공 및 재고 차감 완료 시
  - PENDING → FAILED: 결제 실패 시 (재고 복원)
  - PENDING → EXPIRED: 10분 경과 시 (재고 자동 복원)
  - PENDING/COMPLETED → CANCELLED: 사용자 취소 시 (재고 복원)
- **관련 유스케이스**: [UC-ORDER-02](user-stories.md#uc-order-02-주문-상태-관리)

**FR-ORDER-05: 주문 내역 조회**
- **입력**:
  - 주문 ID (상세 조회)
  - 날짜 범위 (목록 조회)
- **출력**:
  - 주문 정보
  - 주문 상품 목록
  - 결제 정보
  - 쿠폰 사용 정보
- **관련 유스케이스**: [UC-ORDER-04](user-stories.md#uc-order-04-주문-조회)

#### 비기능 요구사항

**NFR-ORDER-PERF: 성능**
- 주문 생성: 평균 500ms 이내 응답
- 주문 조회: 평균 200ms 이내 응답

**NFR-ORDER-RELI: 안정성**
- **주문 금액 정확성**: 금액 계산의 정확성 보장
  - 소수점 오차 없는 계산
  - 쿠폰 할인 정확한 적용
- **데이터 정합성**: 주문 정보와 주문 상품 정보의 일관성 보장

---

### FR-PAYMENT: 결제 관리

| ID | 요구사항 | 우선순위 | 상태 |
|----|---------|---------|------|
| **FR-PAYMENT-01** | 사용자는 주문에 대한 결제를 진행할 수 있어야 함 | MUST | ⏳ 대기 |
| **FR-PAYMENT-02** | 시스템은 결제 완료 시 재고를 차감하고 장바구니를 비워야 함 | MUST | ⏳ 대기 |
| **FR-PAYMENT-03** | 시스템은 결제 실패/취소/만료 시 확보된 재고를 복원해야 함 | MUST | ⏳ 대기 |
| **FR-PAYMENT-04** | 사용자는 재고 확보 후 10분 이내 재결제를 시도할 수 있어야 함 | MUST | ⏳ 대기 |

#### 상세 설명

**FR-PAYMENT-01: 결제 처리**
- **입력**: 주문 ID
- **전제 조건**:
  - 결제는 정상적으로 처리된다고 가정
  - 주문 생성 시 재고가 이미 확보된 상태
  - 재고 확보 후 10분 이내
- **처리 과정**:
  1. 주문 정보 확인 (PENDING 상태)
  2. 재고 확보 상태 및 만료 시간 확인
  3. 만료 시 에러 반환 (재고 확보 만료)
  4. 결제 처리
  5. 결제 기록 저장
  6. 결제 실패 시 재고 복원 (FR-PAYMENT-03 참조)
- **출력**: 결제 완료 상태
- **관련 유스케이스**: [UC-PAYMENT-01](user-stories.md#uc-payment-01-결제-처리)

**FR-PAYMENT-02: 재고 차감 및 장바구니 비우기**
- **트리거**: 결제 완료
- **처리 과정**:
  1. 확보된 재고를 실제 차감으로 전환
  2. 재고 확보 기록 삭제
  3. 주문 상태 변경 (COMPLETED)
  4. 사용자의 장바구니 전체 비우기
- **동시성 제어**: 비관적 락 (이미 확보된 재고에 대한 처리)
- **비고**:
  - 결제 완료 시 장바구니가 자동으로 비워짐
  - 재구매 필요 시 다시 담아야 함
- **관련 유스케이스**: [UC-PAYMENT-01](user-stories.md#uc-payment-01-결제-처리)

**FR-PAYMENT-03: 재고 복원**
- **트리거**:
  - **(수동) 결제 실패**: 결제 프로세스 실패 시
  - **(수동) 사용자 취소**: 사용자가 결제를 취소한 경우
  - **(자동) 재고 확보 만료**: 재고 확보 후 10분 경과 시
- **처리 과정**:
  1. 확보된 재고 조회
  2. 재고 확보 상태 해제
  3. 다른 사용자가 구매 가능하도록 복원
  4. 주문 상태 변경
     - 결제 실패 시: FAILED
     - 사용자 취소 시: CANCELLED
     - 자동 만료 시: EXPIRED
- **자동 복원 배치 작업**:
  - 배치 주기: 1분마다 실행
  - 만료 기준: 재고 확보 후 10분 경과
- **관련 유스케이스**:
  - [UC-PAYMENT-02](user-stories.md#uc-payment-02-결제-실패-처리)
  - [UC-PAYMENT-03](user-stories.md#uc-payment-03-재고-확보-만료)

**FR-PAYMENT-04: 결제 재시도**
- **재시도 조건**: 재고 확보 후 10분 이내
- **처리 과정**:
  1. 주문 상태 확인 (PENDING 또는 FAILED)
  2. 재고 확보 시간 확인 (10분 이내)
  3. 재고 확보 유효 시 결제 재시도 허용
- **10분 경과 시**: 재시도 불가, 새로 주문 생성 필요
- **관련 유스케이스**: [UC-PAYMENT-01](user-stories.md#uc-payment-01-결제-처리)

#### 비기능 요구사항

**NFR-PAYMENT-PERF: 성능**
- 결제 처리: 평균 1초 이내 응답
- 재고 차감: 평균 200ms 이내 응답
- 재고 복원: 평균 100ms 이내 응답

**NFR-PAYMENT-RELI: 안정성**
- **결제 정확성**: 정확한 결제 처리 보장
- **재고 차감 정확성**: 결제 성공 시 재고 차감 보장
- **재고 복원 보장**: 결제 실패/취소 시 재고 복원
- **10분 타임아웃**: 재고 확보 만료 시 자동 복원
- **트랜잭션 보장**: ACID 속성 보장
  - Atomicity: 결제 처리와 재고 차감은 원자적 수행
  - Consistency: 데이터 정합성 유지
  - Isolation: 트랜잭션 격리
  - Durability: 커밋 후 영구 보존

---

### FR-COUPON: 쿠폰 관리 (사용자)

> **참고**: 쿠폰 생성 및 발급 설정 등 Admin 기능은 [Admin 요구사항 분석 - FR-ADMIN-COUPON](requirements-admin.md#fr-admin-coupon-쿠폰-발급-관리)을 참조하세요.

| ID | 요구사항 | 우선순위 | 상태 |
|----|---------|---------|------|
| **FR-COUPON-01** | 사용자는 선착순으로 쿠폰을 발급받을 수 있어야 함 | MUST | ⏳ 대기 |
| **FR-COUPON-02** | 시스템은 쿠폰 발급 시 수량을 제한해야 함 | MUST | ⏳ 대기 |
| **FR-COUPON-03** | 시스템은 1인당 1개의 쿠폰만 발급해야 함 | MUST | ⏳ 대기 |
| **FR-COUPON-04** | 시스템은 쿠폰 유효성을 검증해야 함 | MUST | ⏳ 대기 |
| **FR-COUPON-05** | 사용자는 보유한 쿠폰 목록을 조회할 수 있어야 함 | MUST | ⏳ 대기 |

#### 상세 설명

**FR-COUPON-01: 선착순 쿠폰 발급 받기**
- **전제 조건**: Admin이 쿠폰을 미리 생성해야 함 ([requirements-admin.md](requirements-admin.md#fr-admin-coupon-01-쿠폰-생성) 참조)
- **입력**: 쿠폰 ID
- **처리 과정**:
  1. 쿠폰 정보 조회
  2. 발급 가능 여부 확인 (수량, 기간)
  3. 중복 발급 확인
  4. 사용자에게 쿠폰 발급
  5. 잔여 수량 차감
- **출력**: 발급된 쿠폰 정보
- **관련 유스케이스**: [UC-COUPON-01](user-stories.md#uc-coupon-01-쿠폰-발급)

**FR-COUPON-02: 발급 수량 제한**
- **제한 방식**: 총 발급 수량 관리
- **예시**: 100개 한정 쿠폰
- **동시성 제어**: 비관적 락 (SELECT FOR UPDATE)
  - 100명이 동시 요청 시 정확히 100명만 성공
  - 트랜잭션 내에서 쿠폰 행에 배타적 락 획득
  - 락을 획득한 순서대로 발급 처리
  - 수량 소진 시 즉시 실패 반환
- **관련 유스케이스**: [UC-COUPON-01](user-stories.md#uc-coupon-01-쿠폰-발급)

**FR-COUPON-03: 1인 1매 제한**
- **검증 시점**: 쿠폰 발급 요청 시
- **확인 방법**: 사용자별 쿠폰 발급 이력 조회
- **중복 발급 시**: 에러 반환
- **관련 유스케이스**: [UC-COUPON-01](user-stories.md#uc-coupon-01-쿠폰-발급)

**FR-COUPON-04: 쿠폰 유효성 검증**
- **검증 항목**:
  - 쿠폰 존재 여부
  - 사용자 보유 여부
  - 유효 기간 (시작일 ≤ 현재 ≤ 만료일)
  - 사용 여부 (AVAILABLE 상태)
- **쿠폰 상태 정의**:
  - `AVAILABLE`: 사용 가능 (발급되었으나 미사용)
  - `USED`: 사용 완료 (주문에서 사용됨)
  - `EXPIRED`: 기간 만료 (만료일 경과)
- **상태 전이**:
  - AVAILABLE → USED: 주문 생성 시 쿠폰 적용
  - AVAILABLE → EXPIRED: 만료일 경과 (배치 작업)
  - USED, EXPIRED 상태에서는 사용 불가
- **검증 시점**: 주문 생성 시
- **관련 유스케이스**: [UC-ORDER-01](user-stories.md#uc-order-01-주문-생성)

**FR-COUPON-05: 보유 쿠폰 조회**
- **입력**: 없음 (사용자별 조회)
- **출력**:
  - 쿠폰 목록 (쿠폰명, 할인율, 상태, 만료일)
  - 사용 가능한 쿠폰 수
- **필터**: 사용 가능/사용 완료/만료
- **관련 유스케이스**: [UC-COUPON-02](user-stories.md#uc-coupon-02-보유-쿠폰-조회)

#### 비기능 요구사항

**NFR-COUPON-PERF: 성능**
- 쿠폰 발급: 평균 300ms 이내 응답 (동시성 제어 포함)
- 쿠폰 조회: 평균 100ms 이내 응답

**NFR-COUPON-RELI: 안정성**
- **발급 수량 정확성**: 정확한 수량 제어
  - 동시성 제어를 통한 수량 정합성 보장
  - 테스트: 1000명이 100개 쿠폰 동시 발급 시 정확히 100명만 성공
- **중복 발급 방지**: 1인 1매 제한 보장
- **유효성 검증**: 만료/사용된 쿠폰 사용 불가 보장

---

### FR-DATA: 데이터 연동

| ID | 요구사항 | 우선순위 | 상태 |
|----|---------|---------|------|
| **FR-DATA-01** | 시스템은 주문 완료 후 외부 플랫폼으로 데이터를 전송해야 함 | MUST | ⏳ 대기 |
| **FR-DATA-02** | 시스템은 전송 실패 시에도 주문을 정상 처리해야 함 | MUST | ⏳ 대기 |
| **FR-DATA-03** | 시스템은 전송 실패 시 재시도해야 함 | SHOULD | ⏳ 대기 |
| **FR-DATA-04** | 시스템은 전송 이력을 기록해야 함 | MUST | ⏳ 대기 |

#### 상세 설명

**FR-DATA-01: 주문 데이터 전송**
- **트리거**: 결제 완료 (주문 상태 COMPLETED)
- **전송 데이터**:
  - 주문 ID
  - 주문 상품 목록 (상품 ID, 옵션, 수량, 가격)
  - 결제 금액
  - 주문 일시
- **전송 방식**: 비동기 (Outbox Pattern 권장)
- **관련 유스케이스**: [UC-DATA-01](user-stories.md#uc-data-01-주문-데이터-전송)

**FR-DATA-02: 전송 실패 격리**
- **요구사항**: 외부 전송 실패가 주문 프로세스를 차단하지 않음
- **구현 방안**:
  1. 주문 트랜잭션과 전송 트랜잭션 분리
  2. Outbox 테이블에 전송 데이터 저장
  3. 별도 Worker가 비동기 전송
- **관련 유스케이스**: [UC-DATA-01](user-stories.md#uc-data-01-주문-데이터-전송)

**FR-DATA-03: 전송 재시도**
- **재시도 조건**: 전송 실패 (FAILED 상태)
- **재시도 전략**:
  - 최대 재시도 횟수: 3회
  - 재시도 간격: Exponential Backoff
- **최종 실패 시**: 수동 처리를 위한 알림
- **관련 유스케이스**: [UC-DATA-02](user-stories.md#uc-data-02-전송-재시도)

**FR-DATA-04: 전송 이력 관리**
- **기록 정보**:
  - 주문 ID
  - 전송 데이터 (JSON)
  - 전송 상태 (PENDING/SUCCESS/FAILED)
  - 시도 횟수
  - 생성 일시/전송 일시
- **활용**:
  - 전송 실패 모니터링
  - 재전송 기준 데이터
- **관련 유스케이스**: [UC-DATA-01](user-stories.md#uc-data-01-주문-데이터-전송)

#### 비기능 요구사항

**NFR-DATA-PERF: 성능**
- 데이터 전송은 주문 프로세스를 지연시키지 않아야 함
- 비동기 처리를 통한 응답 시간 최소화

**NFR-DATA-RELI: 안정성**
- **전송 격리**: 외부 전송 실패가 주문 성공을 방해하지 않음
- **재시도 보장**: 실패한 전송은 재시도 큐에 등록
- **이력 기록**: 모든 전송 시도를 기록

---

## 공통 정책

### 재고 확인 정책

시스템의 여러 기능에서 사용하는 공통 재고 확인 정책입니다.

**재고 확인 규칙**:

- **확인 조건**: 요청 수량 ≤ 현재 재고
- **확인 시점**:
  - 장바구니 추가 시 (FR-CART-01)
  - 장바구니 수량 변경 시 (FR-CART-02)
  - 주문 생성 시 재고 확보 (FR-ORDER-02)
- **실패 처리**:
  - 재고 부족 시 에러 반환
  - 에러 메시지: "상품명 - 옵션명이 품절입니다"

**참조**:

- [FR-CART-01: 장바구니 상품 추가](#fr-cart-01-장바구니-상품-추가)
- [FR-CART-02: 수량 변경](#fr-cart-02-수량-변경)
- [FR-ORDER-02: 재고 확인 및 확보](#fr-order-02-재고-확인-및-확보)

---

## 제약사항

### 기술 제약사항

| 제약사항 | 설명 | 영향 |
|---------|------|------|
| **NestJS** | 프레임워크 고정 | NestJS 기반 아키텍처 및 패턴 사용 필수 |
| **Prisma** | ORM 고정 | Prisma 스키마 기반 데이터 모델링 |
| **TypeScript** | 언어 고정 | 타입 안정성 기반 개발 |
| **데이터베이스** | TBD | PostgreSQL 또는 MySQL |

### 아키텍처 제약사항

| 제약사항 | 설명 | 영향 |
|---------|------|------|
| **아키텍처 패턴** | TBD | 클린 아키텍처, 레이어드 아키텍처 등 결정 예정 |
| **의존성 방향** | 도메인 중심 | 외부 의존성은 인터페이스를 통해 격리 |

### 운영 제약사항

| 제약사항 | 설명 | 영향 |
|---------|------|------|
| **외부 전송 의존성** | 외부 플랫폼 장애가 주문 차단 금지 | Outbox Pattern 등 비동기 처리 필수 |
| **동시성 처리** | 재고/쿠폰 정확성 필수 | 락 메커니즘 필수 적용 |
| **Admin 영역 분리** | Admin 기능은 별도 요구사항 문서 관리 | [requirements-admin.md](requirements-admin.md) 참조 |
| **마이크로서비스 분리** | Admin 기능의 추후 분리 가능성 고려 | 도메인 경계 명확히 구분, 느슨한 결합 유지 |

### 개발 제약사항

| 제약사항 | 설명 | 영향 |
|---------|------|------|
| **Issue 문서 우선** | 모든 작업은 issue 파일 생성 후 진행 | 문서 없이 구현 금지 |
| **문서 언어** | dev/* 한글, 기타 영문 | 작성 언어 규칙 준수 |
| **Mermaid 다이어그램** | 모든 다이어그램은 Mermaid 형식 | 외부 도구 사용 금지 |

---

## 요구사항 추적 매트릭스

이 표는 각 사용자 기능 요구사항을 유스케이스, 구현까지 추적합니다.

> **참고**: Admin 기능 요구사항 추적은 [Admin 요구사항 분석 문서](requirements-admin.md#요구사항-추적-매트릭스)를 참조하세요.

| 요구사항 ID | 카테고리 | 설명 | 우선순위 | 유스케이스 | 구현 | 테스트 |
|-----------|---------|------|---------|-----------|------|--------|
| **FR-PROD-01** | 상품 | 상품 목록 조회 | MUST | [UC-PROD-01](user-stories.md) | TBD | ⏳ |
| **FR-PROD-02** | 상품 | 상품 상세 조회 | MUST | [UC-PROD-02](user-stories.md) | TBD | ⏳ |
| **FR-PROD-04** | 상품 | 상품 옵션 조회 | MUST | [UC-PROD-04](user-stories.md) | TBD | ⏳ |
| **FR-PROD-05** | 상품 | 상품 정렬 | SHOULD | [UC-PROD-05](user-stories.md) | TBD | ⏳ |
| **FR-PROD-06** | 상품 | 인기 상품 통계 | SHOULD | [UC-PROD-06](user-stories.md) | TBD | ⏳ |
| **FR-CART-01** | 장바구니 | 상품 추가 | MUST | [UC-CART-01](user-stories.md) | TBD | ⏳ |
| **FR-CART-04** | 장바구니 | 장바구니 조회 | MUST | [UC-CART-04](user-stories.md) | TBD | ⏳ |
| **FR-ORDER-01** | 주문 | 주문 생성 | MUST | [UC-ORDER-01](user-stories.md) | TBD | ⏳ |
| **FR-ORDER-02** | 주문 | 재고 확인 및 확보 | MUST | [UC-ORDER-01](user-stories.md) | TBD | ⏳ |
| **FR-ORDER-04** | 주문 | 주문 상태 관리 | MUST | [UC-ORDER-02](user-stories.md) | TBD | ⏳ |
| **FR-PAYMENT-01** | 결제 | 결제 처리 | MUST | [UC-PAYMENT-01](user-stories.md) | TBD | ⏳ |
| **FR-PAYMENT-02** | 결제 | 재고 차감 | MUST | [UC-PAYMENT-01](user-stories.md) | TBD | ⏳ |
| **FR-PAYMENT-03** | 결제 | 재고 복원 | MUST | [UC-PAYMENT-02](user-stories.md), [UC-PAYMENT-03](user-stories.md) | TBD | ⏳ |
| **FR-PAYMENT-04** | 결제 | 결제 재시도 (10분 내) | MUST | [UC-PAYMENT-01](user-stories.md) | TBD | ⏳ |
| **FR-COUPON-01** | 쿠폰 (사용자) | 쿠폰 발급받기 | MUST | [UC-COUPON-01](user-stories.md) | TBD | ⏳ |
| **FR-COUPON-02** | 쿠폰 (사용자) | 발급 수량 제한 | MUST | [UC-COUPON-01](user-stories.md) | TBD | ⏳ |
| **FR-DATA-01** | 연동 | 주문 데이터 전송 | MUST | [UC-DATA-01](user-stories.md) | TBD | ⏳ |
| **FR-DATA-02** | 연동 | 전송 실패 격리 | MUST | [UC-DATA-01](user-stories.md) | TBD | ⏳ |

**범례**:

- ✅ 테스트 완료
- ⏳ 구현 대기
- ❌ 미구현

---

## 관련 문서

- **다음**: [유스케이스 →](user-stories.md)
- **Admin 요구사항**: [Admin 요구사항 분석 →](requirements-admin.md)
- **ERD**: [ERD 다이어그램](erd.md)
- **API 참조**: [API 명세서](api-spec.md)
- **구현 흐름**: [시퀀스 다이어그램](sequence-diagrams.md)

---

**버전 이력**:
- 1.0.0 (2025-10-28): 초기 요구사항 분석 문서 작성
