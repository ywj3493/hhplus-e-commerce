# Data Integration Domain - Use Cases

**문서 정보**
- **버전**: 2.0.0
- **최종 수정일**: 2025-11-03
- **상태**: Active
- **작성자**: Development Team
- **대상 독자**: Product Managers, Business Analysts, QA

---

**문서 네비게이션**
- ⬆️ 상위: [Dashboard 개요](../README.md)
- ⬅️ 이전: [Coupon 유스케이스](../coupon/use-cases.md)
- ➡️ 다음: [Data 시퀀스 다이어그램](./sequence-diagrams.md)
- 🔗 기술 문서: [Data 시퀀스 다이어그램](./sequence-diagrams.md)

---

## 목차
1. [개요](#1-개요)
2. [유스케이스 목록](#2-유스케이스-목록)
3. [UC-DATA-01: 주문 데이터 전송](#3-uc-data-01-주문-데이터-전송)
4. [UC-DATA-02: 전송 실패 재시도](#4-uc-data-02-전송-실패-재시도)

---

## 1. 개요

### 1.1 도메인 설명
Data Integration 도메인은 외부 시스템으로 주문 데이터를 전송하는 역할을 담당합니다. Outbox Pattern을 사용하여 데이터 일관성을 보장하고, 실패 시 재시도 메커니즘을 제공합니다.

### 1.2 주요 책임
- 주문 완료 시 외부 시스템 데이터 전송
- Outbox Pattern 구현
- 전송 실패 시 재시도 (Exponential Backoff)
- 전송 이력 관리
- 데이터 일관성 보장

### 1.3 Outbox Pattern
```
1. 주문 완료 이벤트 발생
2. DataTransmission 레코드 생성 (status: PENDING)
3. 트랜잭션 커밋
4. 백그라운드 작업이 PENDING 레코드 조회
5. 외부 API 호출
6. 성공 시: status = SENT
7. 실패 시: status = FAILED, retry_count++
```

### 1.4 재시도 전략
- **재시도 간격**: Exponential Backoff (1분, 2분, 4분, 8분, 16분)
- **최대 재시도**: 5회
- **실패 후 처리**: Dead Letter Queue 또는 수동 처리

### 1.5 관련 문서
- [요구사항: FR-DATA-01 ~ FR-DATA-02](../requirements.md)
- [사용자 스토리: US-DATA-01 ~ US-DATA-02](../user-stories.md)
- [데이터 모델: Data Domain](../data-model.md)
- [기술 명세: Data 시퀀스 다이어그램](./sequence-diagrams.md)

---

## 2. 유스케이스 목록

| ID | 유스케이스 명 | User Story | Trigger | 우선순위 |
|----|---------------|------------|---------|----------|
| UC-DATA-01 | 주문 데이터 전송 | US-DATA-01 | OrderCompletedEvent | MUST |
| UC-DATA-02 | 전송 실패 재시도 | US-DATA-02 | Batch Job (1분마다) | MUST |

---

## 3. UC-DATA-01: 주문 데이터 전송

### 3.1 기본 정보

| 항목 | 내용 |
|------|------|
| **Use Case ID** | UC-DATA-01 |
| **Use Case 명** | 주문 데이터 전송 (Outbox Pattern) |
| **Actor** | System (Event Handler) |
| **Goal** | 주문 완료 시 외부 시스템으로 주문 데이터를 안전하게 전송한다 |
| **관련 User Story** | US-DATA-01 |
| **관련 요구사항** | FR-DATA-01 |
| **API Endpoint** | N/A (Domain Event Handler) |
| **우선순위** | MUST |
| **트리거** | OrderCompletedEvent (주문 완료 이벤트) |

### 3.2 유스케이스 설명
주문이 완료되면 외부 시스템(데이터 플랫폼)으로 주문 정보를 전송합니다. Outbox Pattern을 사용하여 트랜잭션 내에서 전송 레코드를 생성하고, 백그라운드 작업이 실제 전송을 처리합니다.

### 3.3 사전 조건 (Pre-conditions)
- 주문이 완료 상태(COMPLETED)여야 함
- 외부 시스템 API가 정상 동작해야 함

### 3.4 주요 흐름 (Main Flow)

**Phase 1: 전송 대기열 등록**
1. **주문 완료 이벤트 발생**
   - 시스템이 주문 완료 이벤트를 감지한다
   - 시스템은 주문 정보를 수집한다 (주문 ID, 사용자 ID, 금액, 상품 목록)

2. **전송 레코드 생성**
   - 시스템은 트랜잭션 내에서 DataTransmission 레코드를 생성한다
   - 시스템은 전송 상태를 'PENDING'으로 설정한다
   - 시스템은 주문 정보를 JSON 형태로 저장한다

3. **트랜잭션 커밋**
   - 시스템은 주문 완료와 전송 레코드 생성을 동시에 커밋한다
   - 시스템은 데이터 일관성을 보장한다

**Phase 2: 실제 데이터 전송**
1. **전송 대상 조회**
   - 백그라운드 작업이 1분마다 실행된다
   - 시스템은 PENDING 상태의 레코드를 조회한다 (최대 10건)

2. **외부 API 호출**
   - 시스템은 각 레코드별로 외부 API를 호출한다
   - 시스템은 주문 정보를 JSON 형태로 전송한다

3. **전송 결과 처리**
   - 전송 성공 시: 상태를 'SENT'로 변경하고 전송 시간을 기록한다
   - 전송 실패 시: 상태를 'FAILED'로 변경하고 재시도 횟수를 증가시킨다

4. **결과 저장**
   - 시스템은 전송 결과를 데이터베이스에 저장한다
   - 시스템은 처리 결과를 로그에 기록한다

### 3.5 대체 흐름 (Alternative Flows)

**AF-1: 외부 API 타임아웃**
- 외부 API가 10초 이내에 응답하지 않는다
- 시스템은 전송 실패로 처리한다
- 시스템은 재시도 대상으로 표시한다

**AF-2: 외부 API 오류 응답**
- 외부 API가 4xx 또는 5xx 에러를 반환한다
- 시스템은 전송 실패로 처리한다
- 시스템은 오류 메시지를 기록하고 재시도 대상으로 표시한다

**AF-3: 네트워크 오류**
- 네트워크 연결이 실패한다
- 시스템은 전송 실패로 처리한다
- 시스템은 재시도 대상으로 표시한다

### 3.6 사후 조건 (Post-conditions)
- 주문 정보가 외부 시스템에 성공적으로 전송된다
- 전송 이력이 데이터베이스에 기록된다
- 실패한 경우 재시도 대상으로 등록된다

### 3.7 비즈니스 규칙 (Business Rules)

| ID | 규칙 | 설명 |
|----|------|------|
| BR-DATA-01 | Outbox Pattern 사용 | 주문 완료와 전송 레코드 생성을 동일 트랜잭션에서 처리 |
| BR-DATA-02 | 비동기 전송 | 실제 전송은 백그라운드 작업에서 처리 |
| BR-DATA-03 | 배치 처리 | 한 번에 최대 10건씩 처리 |
| BR-DATA-04 | 전송 타임아웃 | 외부 API 호출 시 10초 타임아웃 적용 |

### 3.8 예외 케이스 (Exception Cases)

| 예외 상황 | 시스템 동작 |
|-----------|-------------|
| 외부 API 타임아웃 | status = FAILED, 재시도 대상 |
| 외부 API 4xx 에러 | status = FAILED, 재시도 (정책에 따라) |
| 외부 API 5xx 에러 | status = FAILED, 재시도 |
| 네트워크 오류 | status = FAILED, 재시도 |

---

## 4. UC-DATA-02: 전송 실패 재시도

### 4.1 기본 정보

| 항목 | 내용 |
|------|------|
| **Use Case ID** | UC-DATA-02 |
| **Use Case 명** | 전송 실패 재시도 (Exponential Backoff) |
| **Actor** | System (Batch Job) |
| **Goal** | 실패한 데이터 전송을 재시도하여 최종적으로 외부 시스템에 전송한다 |
| **관련 User Story** | US-DATA-02 |
| **관련 요구사항** | FR-DATA-02 |
| **API Endpoint** | N/A (Scheduled Task) |
| **우선순위** | MUST |
| **실행 주기** | 1분마다 |

### 4.2 유스케이스 설명
전송에 실패한 DataTransmission 레코드를 재시도합니다. Exponential Backoff 전략을 사용하며, 최대 5회까지 재시도합니다.

### 4.3 사전 조건 (Pre-conditions)
- 전송 실패한 레코드(status = FAILED)가 존재해야 함
- 재시도 횟수가 5회 미만이어야 함
- 마지막 재시도 이후 충분한 시간이 경과했어야 함 (Exponential Backoff)

### 4.4 주요 흐름 (Main Flow)

1. **재시도 대상 조회**
   - 백그라운드 작업이 1분마다 실행된다
   - 시스템은 재시도 가능한 레코드를 조회한다:
     - 상태가 'FAILED'인 레코드
     - 재시도 횟수가 5회 미만인 레코드
     - Exponential Backoff 시간이 경과한 레코드
   - 시스템은 최대 10건을 조회한다

2. **재시도 가능 여부 확인**
   - 시스템은 각 레코드의 재시도 횟수를 확인한다
   - 시스템은 Exponential Backoff 지연 시간을 계산한다:
     - 1회 실패: 1분 대기
     - 2회 실패: 2분 대기
     - 3회 실패: 4분 대기
     - 4회 실패: 8분 대기
     - 5회 실패: 16분 대기

3. **데이터 재전송**
   - 시스템은 외부 API를 다시 호출한다
   - 시스템은 이전과 동일한 페이로드를 전송한다

4. **재시도 결과 처리**
   - 성공 시: 상태를 'SENT'로 변경하고 전송 완료 처리한다
   - 실패 시: 재시도 횟수를 1 증가시키고 오류 메시지를 기록한다

5. **결과 저장**
   - 시스템은 재시도 결과를 데이터베이스에 저장한다
   - 시스템은 마지막 재시도 시간을 기록한다

### 4.5 대체 흐름 (Alternative Flows)

**AF-1: 최대 재시도 횟수 초과**
- 재시도 횟수가 5회에 도달한다
- 시스템은 재시도를 중단한다
- 시스템은 Dead Letter Queue에 기록하거나 알림을 발송한다
- 시스템은 수동 처리가 필요함을 표시한다

**AF-2: 재시도 가능한 레코드가 없는 경우**
- 시스템은 조회 결과가 0건임을 확인한다
- 시스템은 작업을 종료한다
- 시스템은 다음 실행 주기를 대기한다

**AF-3: 재시도 지연 시간 미경과**
- Exponential Backoff 지연 시간이 아직 경과하지 않았다
- 시스템은 해당 레코드를 건너뛴다
- 시스템은 다음 실행 주기에 다시 시도한다

### 4.6 사후 조건 (Post-conditions)
- 재시도에 성공한 경우 외부 시스템에 데이터가 전송된다
- 재시도에 실패한 경우 재시도 횟수가 증가한다
- 최대 재시도 초과 시 수동 처리 대상으로 표시된다

### 4.7 비즈니스 규칙 (Business Rules)

| ID | 규칙 | 설명 |
|----|------|------|
| BR-DATA-05 | Exponential Backoff | 재시도 간격을 점진적으로 증가 (1, 2, 4, 8, 16분) |
| BR-DATA-06 | 최대 재시도 횟수 | 5회까지만 자동 재시도 |
| BR-DATA-07 | Dead Letter Queue | 5회 초과 시 수동 처리 대상으로 이관 |
| BR-DATA-08 | 배치 크기 | 한 번에 최대 10건씩 재시도 |

### 4.8 예외 케이스 (Exception Cases)

| 예외 상황 | 시스템 동작 |
|-----------|-------------|
| 최대 재시도 초과 | Dead Letter Queue 기록, 수동 처리 필요 |
| 재시도 중 시스템 오류 | 로그 기록, 다음 주기에 재시도 |

### 4.9 재시도 전략 상세

#### Exponential Backoff 테이블
| 재시도 횟수 | 지연 시간 | 누적 대기 시간 | 설명 |
|-------------|-----------|----------------|------|
| 0회 (최초) | 즉시 | 0분 | 최초 전송 시도 |
| 1회 | 1분 | 1분 | 첫 번째 재시도 |
| 2회 | 2분 | 3분 | 두 번째 재시도 |
| 3회 | 4분 | 7분 | 세 번째 재시도 |
| 4회 | 8분 | 15분 | 네 번째 재시도 |
| 5회 | 16분 | 31분 | 다섯 번째 재시도 |
| 6회 이상 | - | - | 자동 재시도 중단, 수동 처리 |

#### 재시도 정책
- **일시적 오류**: 네트워크 타임아웃, 5xx 에러 → 재시도
- **영구적 오류**: 4xx 에러 (설정에 따라) → 재시도 또는 즉시 중단
- **성공**: 재시도 중단, 상태를 SENT로 변경

---

## 5. 도메인 용어 정리

| 용어 | 설명 |
|------|------|
| **Outbox Pattern** | 트랜잭션 내에서 전송 레코드를 생성하고 별도 프로세스가 실제 전송을 처리하는 패턴 |
| **DataTransmission** | 외부 시스템으로 전송할 데이터를 나타내는 Entity |
| **Exponential Backoff** | 재시도 간격을 지수적으로 증가시키는 재시도 전략 |
| **Dead Letter Queue** | 최대 재시도 후에도 실패한 메시지를 저장하는 대기열 |
| **PENDING** | 전송 대기 중인 상태 |
| **SENT** | 전송 완료된 상태 |
| **FAILED** | 전송 실패한 상태 (재시도 대상) |

---

## 6. 관련 문서

- [아키텍처](../architecture.md) - 시스템 아키텍처
- [요구사항 분석](../requirements.md) - 비즈니스 요구사항
- [사용자 스토리](../user-stories.md) - 사용자 관점의 시나리오
- [데이터 모델](../data-model.md) - 데이터베이스 스키마
- [Data 시퀀스 다이어그램](./sequence-diagrams.md) - 기술 구현 명세
- [Order 유스케이스](../order/use-cases.md) - 선행 도메인

---

## 7. 버전 히스토리

| 버전 | 날짜 | 작성자 | 변경 내역 |
|------|------|--------|-----------|
| 1.0.0 | 2025-11-03 | Development Team | 초기 문서 작성 |
| 2.0.0 | 2025-11-03 | Development Team | 비즈니스 관점과 기술 관점 분리 (Issue #006) |

---

**문서 끝**
