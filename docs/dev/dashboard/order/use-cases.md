# Order Domain - Use Cases

**문서 정보**
- **버전**: 2.0.0
- **최종 수정일**: 2025-11-03
- **상태**: Active
- **작성자**: Development Team
- **대상 독자**: Product Managers, Business Analysts, QA

---

**문서 네비게이션**
- ⬆️ 상위: [Dashboard 개요](../README.md)
- ⬅️ 이전: [Cart 유스케이스](../cart/use-cases.md)
- ➡️ 다음: [Order 시퀀스 다이어그램](./sequence-diagrams.md)
- 🔗 기술 문서: [Order 시퀀스 다이어그램](./sequence-diagrams.md)

---

## 목차
1. [개요](#1-개요)
2. [유스케이스 목록](#2-유스케이스-목록)
3. [UC-ORDER-01: 주문 생성](#3-uc-order-01-주문-생성)
4. [UC-ORDER-02: 주문 조회](#4-uc-order-02-주문-조회)
5. [UC-ORDER-03: 주문 목록 조회](#5-uc-order-03-주문-목록-조회)
6. [UC-ORDER-04: 재고 예약 타임아웃 처리](#6-uc-order-04-재고-예약-타임아웃-처리)

---

## 1. 개요

### 1.1 도메인 설명
Order 도메인은 주문 생성, 조회, 재고 예약 관리를 담당합니다. 재고를 예약하고, 결제 완료 후 주문을 확정하는 핵심 비즈니스 로직을 포함합니다.

### 1.2 주요 책임
- 주문 생성 및 재고 예약
- 주문 조회 (단건, 목록)
- 재고 예약 타임아웃 관리 (10분)
- 주문 상태 관리 (PENDING → COMPLETED)
- 쿠폰 적용

### 1.3 재고 예약 정책
- **예약 시점**: 주문 생성 시
- **예약 기간**: 10분 (600초)
- **타임아웃 처리**: 배치 작업으로 예약 해제
- **동시성 제어**: Pessimistic Lock (SELECT FOR UPDATE)

### 1.4 관련 문서
- [요구사항: FR-ORDER-01 ~ FR-ORDER-04](../requirements.md)
- [사용자 스토리: US-ORDER-01 ~ US-ORDER-04](../user-stories.md)
- [API 명세: Order APIs](../api-specification.md)
- [데이터 모델: Order Domain](../data-model.md)
- [기술 명세: Order 시퀀스 다이어그램](./sequence-diagrams.md)

---

## 2. 유스케이스 목록

| ID | 유스케이스 명 | Actor | User Story | API Endpoint | 우선순위 |
|----|---------------|-------|------------|--------------|----------|
| UC-ORDER-01 | 주문 생성 (재고 예약) | Customer | US-ORDER-01 | POST /orders | MUST |
| UC-ORDER-02 | 주문 조회 | Customer | US-ORDER-02 | GET /orders/:id | MUST |
| UC-ORDER-03 | 주문 목록 조회 | Customer | US-ORDER-03 | GET /orders | MUST |
| UC-ORDER-04 | 재고 예약 타임아웃 처리 | System | US-ORDER-04 | Batch Job | MUST |

---

## 3. UC-ORDER-01: 주문 생성

### 3.1 기본 정보

| 항목 | 내용 |
|------|------|
| **Use Case ID** | UC-ORDER-01 |
| **Use Case 명** | 주문 생성 (재고 예약) |
| **Actor** | Customer |
| **Goal** | 고객이 장바구니의 상품으로 주문을 생성하고, 재고를 예약하며, 10분 내 결제를 완료한다 |
| **관련 User Story** | US-ORDER-01 |
| **관련 요구사항** | FR-ORDER-01 |
| **API Endpoint** | POST /orders |
| **우선순위** | MUST |

### 3.2 유스케이스 설명
고객이 장바구니의 상품으로 주문을 생성합니다. 재고를 예약하고, 쿠폰을 적용하며, 10분 내 결제를 대기합니다.

### 3.3 사전 조건 (Pre-conditions)
- 고객이 로그인되어 있어야 함
- 장바구니에 1개 이상의 상품이 담겨 있어야 함
- 각 상품의 재고가 충분해야 함 (availableQuantity >= requestedQuantity)
- (선택) 쿠폰을 사용하는 경우 유효한 쿠폰이어야 함

### 3.4 주요 흐름 (Main Flow)

1. **주문 생성 요청**
   - 고객이 장바구니 페이지에서 "주문하기" 버튼을 클릭한다
   - (선택) 고객이 사용할 쿠폰을 선택한다
   - 시스템은 주문 생성 요청을 처리한다

2. **장바구니 검증**
   - 시스템은 고객의 장바구니 내용을 조회한다
   - 시스템은 장바구니가 비어있지 않은지 확인한다

3. **재고 예약**
   - 시스템은 각 상품의 재고를 확인한다
   - 시스템은 재고가 충분한지 검증한다
   - 시스템은 요청 수량만큼 재고를 예약한다 (available → reserved)
   - 시스템은 재고 예약 정보를 저장한다

4. **쿠폰 적용 (선택)**
   - 고객이 쿠폰을 선택한 경우:
     - 시스템은 쿠폰의 유효성을 검증한다 (유효기간, 사용 여부)
     - 시스템은 고객의 쿠폰 사용 권한을 확인한다
     - 시스템은 쿠폰 할인을 계산한다 (정률 또는 정액)
     - 시스템은 쿠폰을 사용 처리한다

5. **주문 생성**
   - 시스템은 주문 정보를 생성한다:
     - 주문 상태: PENDING
     - 주문 상품: 장바구니 상품의 스냅샷 (이름, 가격, 옵션)
     - 총 금액: 각 상품 금액의 합계
     - 할인 금액: 쿠폰 할인 금액
     - 최종 금액: 총 금액 - 할인 금액
     - 예약 만료 시간: 현재 시간 + 10분

6. **장바구니 비우기**
   - 시스템은 고객의 장바구니를 비운다

7. **주문 확인 페이지 표시**
   - 시스템은 생성된 주문 정보를 표시한다:
     - 주문 번호
     - 주문 상품 목록
     - 최종 결제 금액
     - 예약 만료 시간 (10분 타이머)
   - 시스템은 "결제하기" 버튼을 제공한다

### 3.5 대체 흐름 (Alternative Flows)

**AF-1: 장바구니가 비어있는 경우**
- 시스템은 "장바구니가 비어 있습니다" 에러 메시지를 표시한다
- 시스템은 상품 목록 페이지로 이동할 수 있는 링크를 제공한다

**AF-2: 재고가 부족한 경우**
- 시스템은 "재고가 부족합니다" 에러 메시지를 표시한다
- 시스템은 어떤 상품의 재고가 부족한지 명시한다
- 고객은 장바구니로 돌아가 수량을 조정할 수 있다

**AF-3: 쿠폰이 유효하지 않은 경우**
- 시스템은 "유효하지 않은 쿠폰입니다" 에러 메시지를 표시한다
- 시스템은 쿠폰 없이 주문을 진행할 수 있는 옵션을 제공한다

**AF-4: 쿠폰이 이미 사용된 경우**
- 시스템은 "이미 사용한 쿠폰입니다" 에러 메시지를 표시한다
- 시스템은 쿠폰 없이 주문을 진행할 수 있는 옵션을 제공한다

### 3.6 사후 조건 (Post-conditions)
- 주문이 PENDING 상태로 생성된다
- 각 상품의 재고가 예약된다 (available → reserved)
- (선택) 쿠폰이 사용 처리된다
- 장바구니가 비워진다
- 고객이 10분 내에 결제를 완료해야 한다는 안내를 받는다

### 3.7 비즈니스 규칙 (Business Rules)

| ID | 규칙 | 설명 |
|----|------|------|
| BR-ORDER-01 | 재고 예약 기간 | 재고는 주문 생성 시점부터 10분간 예약됨 |
| BR-ORDER-02 | 스냅샷 저장 | 주문 시점의 상품 정보(이름, 가격, 옵션)를 저장 |
| BR-ORDER-03 | 쿠폰 사용 제한 | 사용자당 쿠폰은 1회만 사용 가능 |
| BR-ORDER-04 | 쿠폰 할인 계산 | 정률 쿠폰: 총액 × (할인율/100), 정액 쿠폰: min(할인금액, 총액) |
| BR-ORDER-05 | 최소 주문 금액 | 최종 금액은 0보다 커야 함 |

### 3.8 예외 케이스 (Exception Cases)

| 예외 상황 | 시스템 동작 |
|-----------|-------------|
| 빈 장바구니 | 400 Bad Request: "장바구니가 비어 있습니다." |
| 재고 부족 | 409 Conflict: "재고가 부족합니다." |
| 유효하지 않은 쿠폰 | 400 Bad Request: "유효하지 않은 쿠폰입니다." |
| 이미 사용한 쿠폰 | 409 Conflict: "이미 사용한 쿠폰입니다." |
| 쿠폰 사용 불가 사용자 | 403 Forbidden: "쿠폰을 사용할 수 없습니다." |

### 3.9 관련 유스케이스
- [UC-CART-02: 장바구니 조회](../cart/use-cases.md) - 주문 전 장바구니 확인
- [UC-PAYMENT-01: 결제 처리](../payment/use-cases.md) - 주문 후 결제 진행

---

## 4. UC-ORDER-02: 주문 조회

### 4.1 기본 정보

| 항목 | 내용 |
|------|------|
| **Use Case ID** | UC-ORDER-02 |
| **Use Case 명** | 주문 조회 |
| **Actor** | Customer |
| **Goal** | 고객이 자신의 특정 주문의 상세 정보를 확인한다 |
| **관련 User Story** | US-ORDER-02 |
| **관련 요구사항** | FR-ORDER-02 |
| **API Endpoint** | GET /orders/:id |
| **우선순위** | MUST |

### 4.2 유스케이스 설명
특정 주문의 상세 정보를 조회합니다. 주문 아이템, 결제 정보, 상태를 포함합니다.

### 4.3 사전 조건 (Pre-conditions)
- 고객이 로그인되어 있어야 함
- 조회하려는 주문이 존재해야 함
- 조회하려는 주문이 본인의 주문이어야 함

### 4.4 주요 흐름 (Main Flow)

1. **주문 조회 요청**
   - 고객이 주문 목록에서 특정 주문을 선택한다
   - 시스템은 주문 상세 페이지로 이동한다

2. **주문 정보 표시**
   - 시스템은 주문의 기본 정보를 표시한다:
     - 주문 번호
     - 주문 날짜
     - 주문 상태 (PENDING, COMPLETED, CANCELED)
   - 시스템은 주문 상품 목록을 표시한다:
     - 상품명 (주문 시점 스냅샷)
     - 옵션 정보
     - 가격 (주문 시점 스냅샷)
     - 수량
     - 소계

3. **금액 정보 표시**
   - 시스템은 주문 금액 정보를 표시한다:
     - 총 상품 금액
     - 할인 금액 (쿠폰)
     - 최종 결제 금액

4. **결제 정보 표시**
   - 주문이 결제 완료된 경우:
     - 시스템은 결제 정보를 표시한다 (결제 방법, 결제 시간)
   - 주문이 결제 대기 중인 경우:
     - 시스템은 남은 예약 시간을 표시한다
     - 시스템은 "결제하기" 버튼을 제공한다

5. **주문 상태별 액션 제공**
   - PENDING 상태: "결제하기" 버튼 제공
   - COMPLETED 상태: 주문 정보만 표시
   - CANCELED 상태: 취소 사유 표시

### 4.5 대체 흐름 (Alternative Flows)

**AF-1: 존재하지 않는 주문 조회**
- 시스템은 "주문을 찾을 수 없습니다" 에러 페이지를 표시한다
- 시스템은 주문 목록 페이지로 돌아갈 수 있는 링크를 제공한다

**AF-2: 다른 사용자의 주문 조회 시도**
- 시스템은 "권한이 없습니다" 에러 메시지를 표시한다
- 시스템은 고객을 주문 목록 페이지로 리다이렉트한다

**AF-3: 예약 시간이 만료된 주문**
- 시스템은 "주문 예약 시간이 만료되었습니다" 메시지를 표시한다
- 시스템은 주문 상태가 CANCELED로 변경되었음을 안내한다

### 4.6 사후 조건 (Post-conditions)
- 고객이 주문의 모든 상세 정보를 확인한다
- 고객이 주문 상태에 따라 적절한 액션을 수행할 수 있다

### 4.7 비즈니스 규칙 (Business Rules)

| ID | 규칙 | 설명 |
|----|------|------|
| BR-ORDER-06 | 소유권 검증 | 본인의 주문만 조회 가능 |
| BR-ORDER-07 | 스냅샷 표시 | 주문 시점의 상품 정보를 표시 (현재 가격과 다를 수 있음) |
| BR-ORDER-08 | 예약 시간 표시 | PENDING 상태 주문은 남은 예약 시간을 실시간으로 표시 |

### 4.8 예외 케이스 (Exception Cases)

| 예외 상황 | 시스템 동작 |
|-----------|-------------|
| 존재하지 않는 주문 | 404 Not Found: "주문을 찾을 수 없습니다." |
| 다른 사용자의 주문 | 403 Forbidden: "권한이 없습니다." |
| 잘못된 UUID 형식 | 400 Bad Request: "잘못된 주문 ID 형식입니다." |

### 4.9 관련 유스케이스
- [UC-ORDER-03: 주문 목록 조회](#5-uc-order-03-주문-목록-조회) - 주문 목록에서 선택
- [UC-PAYMENT-01: 결제 처리](../payment/use-cases.md) - PENDING 상태에서 결제 진행

---

## 5. UC-ORDER-03: 주문 목록 조회

### 5.1 기본 정보

| 항목 | 내용 |
|------|------|
| **Use Case ID** | UC-ORDER-03 |
| **Use Case 명** | 주문 목록 조회 (페이지네이션) |
| **Actor** | Customer |
| **Goal** | 고객이 자신의 전체 주문 내역을 확인하고 주문 상태를 추적한다 |
| **관련 User Story** | US-ORDER-03 |
| **관련 요구사항** | FR-ORDER-03 |
| **API Endpoint** | GET /orders |
| **우선순위** | MUST |

### 5.2 유스케이스 설명
로그인한 고객의 전체 주문 목록을 페이지네이션으로 조회합니다. 최신 주문이 먼저 표시됩니다.

### 5.3 사전 조건 (Pre-conditions)
- 고객이 로그인되어 있어야 함
- (선택) 고객이 주문한 내역이 있으면 표시됨

### 5.4 주요 흐름 (Main Flow)

1. **주문 목록 페이지 접속**
   - 고객이 "내 주문" 메뉴를 클릭한다
   - 시스템은 주문 목록 페이지로 이동한다

2. **주문 목록 표시**
   - 시스템은 고객의 주문 목록을 표시한다 (기본 10개씩):
     - 주문 번호
     - 주문 날짜
     - 주문 상태 (PENDING, COMPLETED, CANCELED)
     - 대표 상품명 (첫 번째 상품)
     - 총 상품 수량
     - 최종 결제 금액
   - 시스템은 최신 주문부터 표시한다 (created_at DESC)

3. **주문 상태별 필터링 (선택)**
   - 고객이 주문 상태를 선택한다 (전체, 결제대기, 완료, 취소)
   - 시스템은 선택한 상태의 주문만 표시한다

4. **페이지 이동**
   - 고객이 다음/이전 페이지로 이동한다
   - 시스템은 해당 페이지의 주문 목록을 표시한다

5. **주문 상세 조회**
   - 고객이 특정 주문을 클릭한다
   - 시스템은 주문 상세 페이지로 이동한다

### 5.5 대체 흐름 (Alternative Flows)

**AF-1: 주문 내역이 없는 경우**
- 시스템은 "주문 내역이 없습니다" 메시지를 표시한다
- 시스템은 상품 목록 페이지로 이동할 수 있는 링크를 제공한다

**AF-2: 필터 조건에 맞는 주문이 없는 경우**
- 시스템은 "조건에 맞는 주문이 없습니다" 메시지를 표시한다
- 시스템은 필터를 초기화할 수 있는 버튼을 제공한다

### 5.6 사후 조건 (Post-conditions)
- 고객이 자신의 주문 내역을 확인한다
- 고객이 주문 상태를 추적할 수 있다
- 고객이 특정 주문을 선택하여 상세 정보를 확인할 수 있다

### 5.7 비즈니스 규칙 (Business Rules)

| ID | 규칙 | 설명 |
|----|------|------|
| BR-ORDER-09 | 기본 정렬 | 최신 주문부터 표시 (created_at DESC) |
| BR-ORDER-10 | 기본 페이지 크기 | 페이지 크기를 지정하지 않으면 기본값 10개 적용 |
| BR-ORDER-11 | 최대 페이지 크기 | 한 번에 최대 100개까지만 조회 가능 |
| BR-ORDER-12 | 본인 주문만 표시 | 로그인한 고객의 주문만 표시 |

### 5.8 예외 케이스 (Exception Cases)

| 예외 상황 | 시스템 동작 |
|-----------|-------------|
| 잘못된 page 값 | 400 Bad Request: "페이지는 1 이상이어야 합니다." |
| 잘못된 limit 값 | 400 Bad Request: "페이지 크기는 1-100 사이여야 합니다." |

### 5.9 관련 유스케이스
- [UC-ORDER-02: 주문 조회](#4-uc-order-02-주문-조회) - 목록에서 상세로 이동
- [UC-ORDER-01: 주문 생성](#3-uc-order-01-주문-생성) - 새 주문 생성 후 목록에 추가

---

## 6. UC-ORDER-04: 재고 예약 타임아웃 처리

### 6.1 기본 정보

| 항목 | 내용 |
|------|------|
| **Use Case ID** | UC-ORDER-04 |
| **Use Case 명** | 재고 예약 타임아웃 처리 (배치 작업) |
| **Actor** | System (Batch Job) |
| **Goal** | 시스템이 10분 동안 결제되지 않은 주문의 재고 예약을 자동으로 해제하여 다른 고객이 구매할 수 있게 한다 |
| **관련 User Story** | US-ORDER-04 |
| **관련 요구사항** | FR-ORDER-04 |
| **API Endpoint** | N/A (Scheduled Task) |
| **우선순위** | MUST |
| **실행 주기** | 1분마다 |

### 6.2 유스케이스 설명
10분이 경과한 PENDING 상태 주문을 찾아 재고 예약을 해제하고 주문을 취소합니다.

### 6.3 사전 조건 (Pre-conditions)
- 시스템에 PENDING 상태의 주문이 존재해야 함
- 예약 만료 시간(reservation_expires_at)이 현재 시간보다 과거여야 함

### 6.4 주요 흐름 (Main Flow)

1. **배치 작업 시작**
   - 스케줄러가 1분마다 배치 작업을 실행한다
   - 시스템은 "재고 예약 타임아웃 처리 시작" 로그를 기록한다

2. **만료된 주문 조회**
   - 시스템은 다음 조건에 맞는 주문을 조회한다:
     - 주문 상태 = PENDING
     - 예약 만료 시간 < 현재 시간
   - 시스템은 조회된 주문 건수를 로그에 기록한다

3. **재고 예약 해제**
   - 각 만료된 주문에 대해:
     - 시스템은 주문의 각 상품별로 재고를 조회한다
     - 시스템은 예약된 재고를 구매 가능 재고로 이동한다 (reserved → available)
     - 시스템은 재고 변경 사항을 저장한다

4. **주문 취소 처리**
   - 시스템은 주문 상태를 CANCELED로 변경한다
   - 시스템은 주문 변경 사항을 저장한다

5. **배치 작업 완료**
   - 시스템은 처리된 주문 건수를 로그에 기록한다
   - 시스템은 "재고 예약 타임아웃 처리 완료" 로그를 기록한다

### 6.5 대체 흐름 (Alternative Flows)

**AF-1: 만료된 주문이 없는 경우**
- 시스템은 "만료된 주문이 없습니다" 로그를 기록한다
- 시스템은 다음 실행 시간까지 대기한다

**AF-2: 재고 해제 중 오류 발생**
- 시스템은 해당 주문의 처리를 건너뛴다
- 시스템은 오류 로그를 기록한다
- 시스템은 다음 주문 처리를 계속한다
- 다음 실행 시 재시도한다

### 6.6 사후 조건 (Post-conditions)
- 만료된 주문의 상태가 CANCELED로 변경된다
- 예약되었던 재고가 다시 구매 가능 상태가 된다
- 다른 고객이 해제된 재고를 구매할 수 있다

### 6.7 비즈니스 규칙 (Business Rules)

| ID | 규칙 | 설명 |
|----|------|------|
| BR-ORDER-13 | 만료 시간 | 주문 생성 후 10분 경과 시 자동 취소 |
| BR-ORDER-14 | 재고 해제 | 예약된 재고를 구매 가능 재고로 복원 (reserved → available) |
| BR-ORDER-15 | 배치 주기 | 1분마다 실행하여 실시간성 보장 |
| BR-ORDER-16 | 트랜잭션 처리 | 각 주문별로 재고 해제와 주문 취소를 원자적으로 처리 |

### 6.8 예외 케이스 (Exception Cases)

| 예외 상황 | 시스템 동작 |
|-----------|-------------|
| 재고를 찾을 수 없음 | 로그 기록 후 해당 아이템 건너뛰기 (다음 아이템 계속 처리) |
| 데이터베이스 연결 실패 | 오류 로그 기록 후 다음 실행 시 재시도 |

### 6.9 관련 유스케이스
- [UC-ORDER-01: 주문 생성](#3-uc-order-01-주문-생성) - 재고 예약 시작
- [UC-PAYMENT-01: 결제 처리](../payment/use-cases.md) - 결제 완료 시 재고 확정

---

## 7. 도메인 용어 정리

| 용어 | 설명 |
|------|------|
| **주문 (Order)** | 고객이 상품을 구매하기 위해 생성한 요청 |
| **주문 상태 (Order Status)** | 주문의 현재 상태 (PENDING, COMPLETED, CANCELED) |
| **주문 아이템 (Order Item)** | 주문에 포함된 각 상품 정보 (스냅샷) |
| **재고 예약 (Stock Reservation)** | 주문 생성 시 재고를 임시로 예약하는 것 |
| **예약 만료 (Reservation Expiration)** | 주문 생성 후 10분 경과 시 예약이 자동 해제됨 |
| **스냅샷 (Snapshot)** | 주문 시점의 상품 정보를 저장하여 이후 변경에 영향받지 않게 함 |
| **쿠폰 할인 (Coupon Discount)** | 주문에 적용되는 쿠폰 할인 금액 |
| **최종 금액 (Final Amount)** | 총 금액 - 할인 금액 |

---

## 8. 관련 문서

- [아키텍처](../architecture.md) - 시스템 아키텍처
- [요구사항 분석](../requirements.md) - 비즈니스 요구사항
- [사용자 스토리](../user-stories.md) - 사용자 관점의 시나리오
- [API 명세서](../api-specification.md) - REST API 계약
- [데이터 모델](../data-model.md) - 데이터베이스 스키마
- [Order 시퀀스 다이어그램](./sequence-diagrams.md) - 기술 구현 명세
- [Cart 유스케이스](../cart/use-cases.md) - 이전 도메인
- [Payment 유스케이스](../payment/use-cases.md) - 다음 도메인

---

## 9. 버전 히스토리

| 버전 | 날짜 | 작성자 | 변경 내역 |
|------|------|--------|-----------|
| 1.0.0 | 2025-11-03 | Development Team | 초기 문서 작성 |
| 2.0.0 | 2025-11-03 | Development Team | 비즈니스 관점과 기술 관점 분리 (Issue #006) |

---

**문서 끝**
