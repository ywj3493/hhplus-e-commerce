# Payment Domain - Use Cases

**문서 정보**
- **버전**: 2.0.0
- **최종 수정일**: 2025-11-03
- **상태**: Active
- **작성자**: Development Team
- **대상 독자**: Product Managers, Business Analysts, QA

---

**문서 네비게이션**
- ⬆️ 상위: [Dashboard 개요](../README.md)
- ⬅️ 이전: [Order 유스케이스](../order/use-cases.md)
- ➡️ 다음: [Payment 시퀀스 다이어그램](./sequence-diagrams.md)
- 🔗 기술 문서: [Payment 시퀀스 다이어그램](./sequence-diagrams.md)

---

## 목차
1. [개요](#1-개요)
2. [유스케이스 목록](#2-유스케이스-목록)
3. [UC-PAYMENT-01: 결제 처리](#3-uc-payment-01-결제-처리)
4. [UC-PAYMENT-02: 결제 완료 후 재고 확정](#4-uc-payment-02-결제-완료-후-재고-확정)

---

## 1. 개요

### 1.1 도메인 설명
Payment 도메인은 주문에 대한 결제 처리와 결제 완료 후 재고 확정을 담당합니다. 외부 결제 API와 연동하며, 결제 성공 시 주문을 완료 상태로 변경하고 예약된 재고를 확정합니다.

### 1.2 주요 책임
- 외부 결제 API 연동
- 결제 정보 저장
- 결제 완료 시 주문 상태 변경 (PENDING → COMPLETED)
- 재고 확정 (reserved → sold)
- 잔액 차감 (간단 구현)
- 결제 실패 시 재고 해제

### 1.3 관련 문서
- [요구사항: FR-PAYMENT-01 ~ FR-PAYMENT-02](../requirements.md)
- [사용자 스토리: US-PAYMENT-01 ~ US-PAYMENT-02](../user-stories.md)
- [API 명세: Payment APIs](../api-specification.md)
- [데이터 모델: Payment Domain](../data-model.md)
- [기술 명세: Payment 시퀀스 다이어그램](./sequence-diagrams.md)

---

## 2. 유스케이스 목록

| ID | 유스케이스 명 | Actor | User Story | API Endpoint | 우선순위 |
|----|---------------|-------|------------|--------------|----------|
| UC-PAYMENT-01 | 결제 처리 | Customer | US-PAYMENT-01 | POST /payments | MUST |
| UC-PAYMENT-02 | 결제 완료 후 재고 확정 | System | US-PAYMENT-02 | (Internal) | MUST |

---

## 3. UC-PAYMENT-01: 결제 처리

### 3.1 기본 정보

| 항목 | 내용 |
|------|------|
| **Use Case ID** | UC-PAYMENT-01 |
| **Use Case 명** | 결제 처리 (외부 API 연동) |
| **Actor** | Customer |
| **Goal** | 고객이 주문에 대한 결제를 진행하여 주문을 완료한다 |
| **관련 User Story** | US-PAYMENT-01 |
| **관련 요구사항** | FR-PAYMENT-01 |
| **API Endpoint** | POST /payments |
| **우선순위** | MUST |

### 3.2 유스케이스 설명
고객이 주문에 대한 결제를 진행합니다. 외부 결제 API를 호출하여 결제를 처리하고, 성공 시 주문이 완료되며 재고가 확정됩니다.

### 3.3 사전 조건 (Pre-conditions)
- 유효한 주문이 생성되어 있어야 함 (상태: PENDING)
- 주문의 재고 예약이 완료되어 있어야 함
- 주문 예약 시간(10분)이 만료되지 않았어야 함
- 고객이 인증된 상태여야 함

### 3.4 주요 흐름 (Main Flow)

1. **결제 정보 입력**
   - 고객이 주문 상세 페이지에서 "결제하기" 버튼을 클릭한다
   - 시스템은 결제 방법 선택 화면을 표시한다
   - 고객이 결제 방법을 선택한다 (잔액 결제, 신용카드)

2. **결제 정보 확인**
   - 시스템은 주문 정보를 표시한다:
     - 상품 목록
     - 총 금액
     - 할인 금액 (쿠폰 적용 시)
     - 최종 결제 금액
   - 고객이 결제 정보를 확인한다

3. **잔액 결제 (BALANCE)**
   - 고객이 잔액 결제를 선택한 경우
   - 시스템은 현재 잔액과 결제 금액을 비교한다
   - 잔액이 충분하면 결제를 진행한다

4. **외부 API 결제 (CREDIT_CARD)**
   - 고객이 신용카드 결제를 선택한 경우
   - 시스템은 외부 결제 API를 호출하여 결제를 요청한다
   - 외부 API가 결제를 승인하면 결제를 진행한다

5. **결제 완료 처리**
   - 시스템은 결제 정보를 저장한다
   - 시스템은 사용자 잔액을 차감한다 (잔액 결제인 경우)
   - 시스템은 결제 완료 이벤트를 발행한다
   - 시스템은 결제 완료 화면을 표시한다

6. **결과 확인**
   - 고객이 결제 완료 정보를 확인한다:
     - 결제 ID
     - 결제 금액
     - 결제 방법
     - 거래 번호

### 3.5 대체 흐름 (Alternative Flows)

**AF-1: 존재하지 않는 주문**
- 고객이 존재하지 않는 주문 ID로 결제를 시도한다
- 시스템은 "주문을 찾을 수 없습니다" 에러 메시지를 표시한다

**AF-2: 다른 사용자의 주문**
- 고객이 다른 사용자의 주문에 대해 결제를 시도한다
- 시스템은 "권한이 없습니다" 에러 메시지를 표시한다

**AF-3: 이미 결제된 주문**
- 고객이 이미 완료된 주문에 대해 결제를 시도한다
- 시스템은 "대기 중인 주문만 결제할 수 있습니다" 에러 메시지를 표시한다

**AF-4: 주문 예약 시간 만료**
- 고객이 예약 시간(10분)이 지난 주문에 대해 결제를 시도한다
- 시스템은 "주문 예약 시간이 만료되었습니다" 에러 메시지를 표시한다
- 시스템은 예약된 재고를 해제한다

**AF-5: 잔액 부족**
- 고객의 잔액이 결제 금액보다 부족한 경우
- 시스템은 "잔액이 부족합니다" 에러 메시지를 표시한다
- 시스템은 충전 페이지로 이동할 수 있는 옵션을 제공한다

**AF-6: 외부 API 결제 실패**
- 외부 결제 API가 결제를 거부한 경우
- 시스템은 "결제에 실패했습니다" 에러 메시지를 표시한다
- 시스템은 실패 사유를 표시한다 (한도 초과, 카드 정지 등)

### 3.6 사후 조건 (Post-conditions)
- 결제 정보가 시스템에 저장된다
- 사용자 잔액이 차감된다 (잔액 결제인 경우)
- 결제 완료 이벤트가 발행되어 후속 처리가 시작된다
- 고객이 결제 완료 정보를 확인할 수 있다

### 3.7 비즈니스 규칙 (Business Rules)

| ID | 규칙 | 설명 |
|----|------|------|
| BR-PAYMENT-01 | 주문 소유권 확인 | 본인의 주문만 결제 가능 |
| BR-PAYMENT-02 | 주문 상태 확인 | PENDING 상태의 주문만 결제 가능 |
| BR-PAYMENT-03 | 예약 시간 확인 | 10분 이내의 주문만 결제 가능 |
| BR-PAYMENT-04 | 잔액 검증 | 잔액 결제 시 사용자 잔액이 충분해야 함 |
| BR-PAYMENT-05 | 트랜잭션 처리 | 결제 실패 시 모든 변경사항 롤백 |

### 3.8 예외 케이스 (Exception Cases)

| 예외 상황 | 시스템 동작 |
|-----------|-------------|
| 존재하지 않는 주문 | 404 Not Found: "주문을 찾을 수 없습니다." |
| 다른 사용자의 주문 | 403 Forbidden: "권한이 없습니다." |
| 주문 상태가 PENDING 아님 | 400 Bad Request: "대기 중인 주문만 결제할 수 있습니다." |
| 주문 예약 만료 | 410 Gone: "주문 예약 시간이 만료되었습니다." |
| 잔액 부족 | 402 Payment Required: "잔액이 부족합니다." |
| 외부 API 결제 실패 | 402 Payment Required: "결제에 실패했습니다." |
| 외부 API 호출 실패 | 500 Internal Server Error: "결제 API 호출 실패" |

### 3.9 관련 유스케이스
- [UC-ORDER-01: 주문 생성](../order/use-cases.md) - 결제 전 주문 생성
- [UC-PAYMENT-02: 결제 완료 후 재고 확정](#4-uc-payment-02-결제-완료-후-재고-확정) - 결제 후 처리

---

## 4. UC-PAYMENT-02: 결제 완료 후 재고 확정

### 4.1 기본 정보

| 항목 | 내용 |
|------|------|
| **Use Case ID** | UC-PAYMENT-02 |
| **Use Case 명** | 결제 완료 후 재고 확정 및 주문 완료 처리 |
| **Actor** | System (Event Handler) |
| **Goal** | 결제 완료 후 주문을 완료 상태로 변경하고 재고를 확정한다 |
| **관련 User Story** | US-PAYMENT-02 |
| **관련 요구사항** | FR-PAYMENT-02 |
| **API Endpoint** | N/A (Domain Event Handler) |
| **우선순위** | MUST |
| **트리거** | PaymentCompletedEvent |

### 4.2 유스케이스 설명
결제 완료 이벤트를 수신하여 주문을 완료 상태로 변경하고, 예약된 재고를 판매 완료로 확정합니다. 이는 시스템 내부 프로세스로 자동으로 실행됩니다.

### 4.3 사전 조건 (Pre-conditions)
- 결제가 성공적으로 완료되어야 함
- PaymentCompletedEvent가 발행되어야 함
- 주문이 PENDING 상태여야 함
- 재고가 예약(reserved) 상태여야 함

### 4.4 주요 흐름 (Main Flow)

1. **이벤트 수신**
   - 시스템이 PaymentCompletedEvent를 수신한다
   - 이벤트에는 주문 ID와 결제 ID가 포함되어 있다

2. **주문 조회**
   - 시스템이 주문 ID로 주문을 조회한다
   - 시스템이 주문 상태를 확인한다 (PENDING)
   - 시스템이 주문 예약 만료 여부를 확인한다

3. **주문 완료 처리**
   - 시스템이 주문 상태를 COMPLETED로 변경한다
   - 시스템이 변경된 주문을 저장한다

4. **재고 확정 처리**
   - 시스템이 주문의 각 상품에 대해 재고를 조회한다
   - 시스템이 예약된 수량을 판매 완료로 이동한다:
     - reservedQuantity 감소
     - soldQuantity 증가
   - 시스템이 변경된 재고를 저장한다

5. **처리 완료**
   - 시스템이 처리 성공을 로그에 기록한다
   - 시스템이 트랜잭션을 커밋한다

### 4.5 대체 흐름 (Alternative Flows)

**AF-1: 주문을 찾을 수 없음**
- 시스템이 주문 ID로 주문을 찾을 수 없는 경우
- 시스템은 에러를 로그에 기록한다
- 시스템은 Dead Letter Queue로 이벤트를 이동한다

**AF-2: 주문 상태가 PENDING이 아님**
- 주문이 이미 완료(COMPLETED) 상태인 경우
- 시스템은 중복 처리로 판단하여 무시한다 (멱등성 보장)
- 시스템은 경고를 로그에 기록한다

**AF-3: 재고 확정 실패**
- 예약된 재고가 부족한 경우
- 시스템은 트랜잭션을 롤백한다
- 시스템은 에러를 로그에 기록한다
- 시스템은 재시도 또는 Dead Letter Queue로 이동한다

### 4.6 사후 조건 (Post-conditions)
- 주문 상태가 COMPLETED로 변경된다
- 예약된 재고가 판매 완료로 확정된다
- 고객이 주문 완료 상태를 확인할 수 있다
- 재고 수량이 정확하게 업데이트된다

### 4.7 비즈니스 규칙 (Business Rules)

| ID | 규칙 | 설명 |
|----|------|------|
| BR-PAYMENT-06 | 주문 완료 조건 | PENDING 상태이고 만료되지 않은 주문만 완료 가능 |
| BR-PAYMENT-07 | 재고 확정 | 예약 수량만큼 sold로 이동 |
| BR-PAYMENT-08 | 멱등성 보장 | 동일 이벤트 중복 처리 시 무시 |
| BR-PAYMENT-09 | 트랜잭션 원자성 | 주문 완료와 재고 확정은 하나의 트랜잭션으로 처리 |

### 4.8 예외 케이스 (Exception Cases)

| 예외 상황 | 시스템 동작 |
|-----------|-------------|
| 주문을 찾을 수 없음 | 로그 기록, Dead Letter Queue 이동 |
| 주문 상태가 PENDING 아님 | 로그 기록, 무시 (멱등성) |
| 재고 확정 실패 | 트랜잭션 롤백, 재시도 |
| 트랜잭션 실패 | 롤백, Dead Letter Queue 이동 |

### 4.9 관련 유스케이스
- [UC-PAYMENT-01: 결제 처리](#3-uc-payment-01-결제-처리) - 이벤트 발행
- [UC-ORDER-01: 주문 생성](../order/use-cases.md) - 초기 주문 생성

---

## 5. 도메인 용어 정리

| 용어 | 설명 |
|------|------|
| **결제 (Payment)** | 주문에 대한 금전적 거래 |
| **결제 방법 (Payment Method)** | 신용카드, 잔액 등 결제 수단 |
| **거래 번호 (Transaction ID)** | 외부 결제 API에서 발급하는 고유 식별자 |
| **잔액 (Balance)** | 사용자 계정의 사용 가능한 금액 |
| **재고 예약 (Reserved Stock)** | 주문 생성 시 확보한 재고 |
| **재고 확정 (Stock Confirmation)** | 예약 재고를 판매 완료로 전환 |
| **도메인 이벤트 (Domain Event)** | 비즈니스 로직 실행 시 발생하는 이벤트 |

---

## 6. 관련 문서

- [아키텍처](../architecture.md) - 시스템 아키텍처
- [요구사항 분석](../requirements.md) - 비즈니스 요구사항
- [사용자 스토리](../user-stories.md) - 사용자 관점의 시나리오
- [API 명세서](../api-specification.md) - REST API 계약
- [데이터 모델](../data-model.md) - 데이터베이스 스키마
- [Payment 시퀀스 다이어그램](./sequence-diagrams.md) - 기술 구현 명세
- [Order 유스케이스](../order/use-cases.md) - 이전 도메인
- [Coupon 유스케이스](../coupon/use-cases.md) - 다음 도메인

---

## 7. 버전 히스토리

| 버전 | 날짜 | 작성자 | 변경 내역 |
|------|------|--------|-----------|
| 1.0.0 | 2025-11-03 | Development Team | 초기 문서 작성 |
| 2.0.0 | 2025-11-03 | Development Team | 비즈니스 관점과 기술 관점 분리 (Issue #006) |

---

**문서 끝**
