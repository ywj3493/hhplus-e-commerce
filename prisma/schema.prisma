// E-Commerce 백엔드 서비스 Prisma 스키마
// 데이터베이스: MySQL 8.0
// ORM: Prisma 6.x

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// User 도메인
// ============================================================================

/// 사용자 엔티티
/// - 이메일은 nullable (선택적)
model User {
  id        String    @id @default(uuid()) // 사용자 고유 ID (UUID)
  name      String // 사용자 이름
  email     String? // 이메일 (선택적)
  createdAt DateTime  @default(now()) // 생성 일시
  updatedAt DateTime  @updatedAt // 수정 일시

  orders      Order[] // 사용자의 주문들
  payments    Payment[] // 사용자의 결제 내역들
  userCoupons UserCoupon[] // 사용자가 발급받은 쿠폰들

  @@index([createdAt]) // 생성일 인덱스
  @@map("users") // 테이블명: users
}

// ============================================================================
// Product 도메인
// ============================================================================

/// 카테고리 엔티티
/// - 단일 계층 구조
/// - 카테고리명은 고유해야 함
model Category {
  id        String   @id @default(uuid()) // 카테고리 고유 ID (UUID)
  name      String   @unique // 카테고리명 (고유)
  createdAt DateTime @default(now()) // 생성 일시
  updatedAt DateTime @updatedAt // 수정 일시

  products Product[] // 이 카테고리에 속한 상품들

  @@map("categories") // 테이블명: categories
}

/// 상품 엔티티
/// - 카테고리에 속함
/// - 옵션 유무에 따라 hasOptions 플래그 사용
model Product {
  id          String   @id @default(uuid()) // 상품 고유 ID (UUID)
  name        String // 상품명
  description String   @db.Text // 상품 설명
  price       Decimal  @db.Decimal(10, 2) // 기본 가격
  imageUrl    String // 상품 이미지 URL
  categoryId  String // 카테고리 ID (FK)
  hasOptions  Boolean  @default(false) // 옵션 여부
  createdAt   DateTime @default(now()) // 생성 일시
  updatedAt   DateTime @updatedAt // 수정 일시

  category   Category         @relation(fields: [categoryId], references: [id]) // 카테고리
  options    ProductOption[] // 상품 옵션들
  stocks     Stock[] // 재고 정보
  orderItems OrderItem[] // 주문 항목들 (스냅샷 참조)

  @@index([categoryId]) // 카테고리별 조회 최적화
  @@index([createdAt]) // 최신순 정렬 최적화
  @@map("products") // 테이블명: products
}

/// 상품 옵션 엔티티
/// - 색상, 사이즈 등의 옵션
/// - 옵션별 추가 가격 설정 가능
model ProductOption {
  id              String   @id @default(uuid()) // 옵션 고유 ID (UUID)
  productId       String // 상품 ID (FK)
  type            String // 옵션 타입 (색상, 사이즈 등)
  name            String // 옵션명 (Red, XL 등)
  additionalPrice Decimal  @db.Decimal(10, 2) // 추가 가격
  createdAt       DateTime @default(now()) // 생성 일시
  updatedAt       DateTime @updatedAt // 수정 일시

  product    Product     @relation(fields: [productId], references: [id]) // 상품
  stocks     Stock[] // 이 옵션의 재고 정보
  orderItems OrderItem[] // 주문 항목들 (스냅샷 참조)

  @@index([productId]) // 상품별 옵션 조회 최적화
  @@map("product_options") // 테이블명: product_options
}

/// 재고 엔티티 (동시성 제어 대상)
/// - 상품별 또는 옵션별 재고 관리
/// - productOptionId가 null이면 옵션이 없는 상품의 재고
/// - 비관적 락(SELECT FOR UPDATE)을 통한 동시성 제어
model Stock {
  id                String   @id @default(uuid()) // 재고 고유 ID (UUID)
  productId         String // 상품 ID (FK)
  productOptionId   String? // 옵션 ID (FK, nullable)
  totalQuantity     Int // 총 수량
  availableQuantity Int // 구매 가능 수량
  reservedQuantity  Int      @default(0) // 예약된 수량 (주문 중)
  soldQuantity      Int      @default(0) // 판매 완료 수량
  updatedAt         DateTime @updatedAt // 수정 일시

  product       Product        @relation(fields: [productId], references: [id]) // 상품
  productOption ProductOption? @relation(fields: [productOptionId], references: [id]) // 옵션 (nullable)

  @@unique([productId, productOptionId]) // 상품+옵션 조합은 고유
  @@index([productId]) // 상품별 재고 조회 최적화
  @@index([productOptionId]) // 옵션별 재고 조회 최적화
  @@map("stocks") // 테이블명: stocks
}

// ============================================================================
// Order 도메인
// ============================================================================

/// 주문 엔티티
/// - 사용자의 구매 주문 정보
/// - 재고 예약 만료 시간 관리 (10분)
/// - 주문 상태: PENDING, PAID, CANCELLED
model Order {
  id                   String    @id @default(uuid()) // 주문 고유 ID (UUID)
  userId               String // 사용자 ID (FK)
  status               String // 주문 상태 (PENDING, PAID, CANCELLED)
  totalAmount          Decimal   @db.Decimal(10, 2) // 총 금액
  discountAmount       Decimal   @db.Decimal(10, 2) @default(0) // 할인 금액
  finalAmount          Decimal   @db.Decimal(10, 2) // 최종 결제 금액
  userCouponId         String? // 사용한 쿠폰 ID (nullable)
  reservationExpiresAt DateTime // 재고 예약 만료 시간
  createdAt            DateTime  @default(now()) // 생성 일시
  paidAt               DateTime? // 결제 완료 일시 (nullable)
  updatedAt            DateTime  @updatedAt // 수정 일시

  user    User        @relation(fields: [userId], references: [id]) // 사용자
  items   OrderItem[] // 주문 항목들
  payment Payment? // 결제 정보 (1:1)

  @@index([userId]) // 사용자별 조회 최적화
  @@index([status]) // 상태별 조회 최적화
  @@index([createdAt]) // 생성일 조회 최적화
  @@index([reservationExpiresAt]) // 만료 예약 조회 최적화
  @@map("orders") // 테이블명: orders
}

/// 주문 항목 엔티티 (스냅샷 패턴)
/// - 주문 시점의 상품 정보를 저장
/// - 상품명, 옵션명, 가격은 주문 후 변경되어도 영향받지 않음
model OrderItem {
  id                String   @id @default(uuid()) // 주문 항목 고유 ID (UUID)
  orderId           String // 주문 ID (FK)
  productId         String // 상품 ID (FK)
  productName       String // 상품명 (스냅샷)
  productOptionId   String? // 옵션 ID (FK, nullable)
  productOptionName String? // 옵션명 (스냅샷, nullable)
  quantity          Int // 구매 수량
  unitPrice         Decimal  @db.Decimal(10, 2) // 단가 (스냅샷)
  totalPrice        Decimal  @db.Decimal(10, 2) // 총 가격
  createdAt         DateTime @default(now()) // 생성 일시

  order         Order          @relation(fields: [orderId], references: [id]) // 주문
  product       Product        @relation(fields: [productId], references: [id]) // 상품
  productOption ProductOption? @relation(fields: [productOptionId], references: [id]) // 옵션 (nullable)

  @@index([orderId]) // 주문별 조회 최적화
  @@index([productId]) // 상품별 조회 최적화
  @@map("order_items") // 테이블명: order_items
}

/// 결제 엔티티
/// - 주문에 대한 결제 정보
/// - 주문과 1:1 관계
/// - 결제 수단: CREDIT_CARD (현재 1가지)
model Payment {
  id            String   @id @default(uuid()) // 결제 고유 ID (UUID)
  orderId       String   @unique // 주문 ID (FK, unique - 1:1 관계)
  userId        String // 사용자 ID (FK)
  amount        Decimal  @db.Decimal(10, 2) // 결제 금액
  method        String // 결제 수단 (CREDIT_CARD)
  transactionId String // 외부 결제 거래 번호
  createdAt     DateTime @default(now()) // 생성 일시

  order Order @relation(fields: [orderId], references: [id]) // 주문
  user  User  @relation(fields: [userId], references: [id]) // 사용자

  @@index([userId]) // 사용자별 조회 최적화
  @@index([transactionId]) // 거래 번호 조회 최적화
  @@map("payments") // 테이블명: payments
}

// ============================================================================
// Coupon 도메인
// ============================================================================

/// 쿠폰 엔티티 (동시성 제어 대상)
/// - 선착순 발급 (totalQuantity 제한)
/// - 비관적 락(SELECT FOR UPDATE)을 통한 동시성 제어
/// - 할인 타입: PERCENTAGE (퍼센트), FIXED (정액)
model Coupon {
  id             String   @id @default(uuid()) // 쿠폰 고유 ID (UUID)
  name           String // 쿠폰명
  description    String   @db.Text // 쿠폰 설명
  discountType   String // 할인 타입 (PERCENTAGE, FIXED)
  discountValue  Decimal  @db.Decimal(10, 2) // 할인 값 (퍼센트 또는 금액)
  minAmount      Decimal? @db.Decimal(10, 2) // 최소 주문 금액 (nullable)
  totalQuantity  Int // 총 발급 가능 수량
  issuedQuantity Int      @default(0) // 발급된 수량
  validFrom      DateTime // 유효 시작일
  validUntil     DateTime // 유효 종료일
  createdAt      DateTime @default(now()) // 생성 일시
  updatedAt      DateTime @updatedAt // 수정 일시

  userCoupons UserCoupon[] // 발급된 사용자 쿠폰들

  @@index([validFrom, validUntil]) // 유효기간 조회 최적화
  @@index([issuedQuantity]) // 발급 수량 조회 최적화
  @@map("coupons") // 테이블명: coupons
}

/// 사용자 쿠폰 엔티티
/// - 사용자에게 발급된 쿠폰
/// - 사용 여부 및 만료 상태 관리
/// - 중복 발급 방지: @@unique([userId, couponId])
model UserCoupon {
  id        String    @id @default(uuid()) // 사용자 쿠폰 고유 ID (UUID)
  userId    String // 사용자 ID (FK)
  couponId  String // 쿠폰 ID (FK)
  isUsed    Boolean   @default(false) // 사용 여부
  usedAt    DateTime? // 사용 일시 (nullable)
  issuedAt  DateTime  @default(now()) // 발급 일시
  expiresAt DateTime // 만료 일시

  user   User   @relation(fields: [userId], references: [id]) // 사용자
  coupon Coupon @relation(fields: [couponId], references: [id]) // 쿠폰

  @@unique([userId, couponId]) // 중복 발급 방지 (BR-COUPON-01)
  @@index([userId]) // 사용자별 조회 최적화
  @@index([couponId]) // 쿠폰별 조회 최적화
  @@index([isUsed]) // 사용 여부 조회 최적화
  @@map("user_coupons") // 테이블명: user_coupons
}
